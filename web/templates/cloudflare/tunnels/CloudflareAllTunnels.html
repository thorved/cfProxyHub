<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Cloudflare Tunnels - CF Proxy Hub</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="/assets/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="/assets/vendors/css/vendor.bundle.base.css">
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <!-- End layout styles -->
    <link rel="shortcut icon" href="/assets/images/favicon.png" />
  </head>
  <body>
    <div class="container-scroller">
      <!-- partial:partials/_sidebar.html -->
      {{template "sidebar.html" .}}
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
        <!-- partial:partials/_navbar.html -->
        {{template "header.html" .}}
        <!-- partial -->
        <div class="main-panel">
          <div class="content-wrapper">
            <div class="page-header">
              <h3 class="page-title">
                <i class="mdi mdi-pipe text-primary"></i>
                Cloudflare Tunnels
              </h3>
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                  <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                  <li class="breadcrumb-item active" aria-current="page">Tunnels</li>
                </ol>
              </nav>
            </div>
            <div class="row">
              <!-- Tunnel Management Header Card -->
              <div class="col-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                      <div>
                        <h4 class="card-title mb-2">
                          <i class="mdi mdi-pipe text-info mr-2"></i>
                          Manage Your Cloudflare Tunnels
                        </h4>
                        <p class="card-description text-muted">
                          View, create, and manage your Cloudflare tunnels for the selected account.
                        </p>
                      </div>
                      <div class="d-flex">
                        <button class="btn btn-primary btn-sm mr-2" id="refreshTunnels">
                          <i class="mdi mdi-refresh"></i> Refresh
                        </button>
                        <a href="/cloudflare/tunnels/create" class="btn btn-success btn-sm">
                          <i class="mdi mdi-plus"></i> Create Tunnel
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Current Account Info Card -->
              <div class="col-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                      <h5 class="card-title mb-0">
                        <i class="mdi mdi-account-circle text-info mr-2"></i>
                        Current Account
                      </h5>
                      <span class="badge badge-success" id="currentAccountBadge">Loading...</span>
                    </div>
                    <div id="currentAccountInfo" class="d-flex align-items-center">
                      <div class="preview-icon bg-gradient-primary rounded-circle mr-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        <i class="mdi mdi-account text-white"></i>
                      </div>
                      <div>
                        <h6 class="mb-1 font-weight-medium" id="currentAccountName">No Account Selected</h6>
                        <p class="text-muted small mb-0" id="currentAccountId">Please select an account from the Accounts page</p>
                      </div>
                    </div>
                    <div class="mt-3" id="noAccountWarning" style="display: none;">
                      <div class="alert alert-warning">
                        <i class="mdi mdi-alert-triangle mr-2"></i>
                        <strong>No Account Selected:</strong> Please go to the 
                        <a href="/cloudflare/accounts" class="alert-link">Accounts page</a> 
                        to select an active account first.
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Loading State -->
              <div class="col-12" id="loadingState" style="display: none;">
                <div class="card">
                  <div class="card-body text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                      <span class="sr-only">Loading...</span>
                    </div>
                    <h5 class="text-muted">Loading tunnels...</h5>
                    <p class="text-muted">This may take a few moments</p>
                  </div>
                </div>
              </div>

              <!-- Tunnels Grid -->
              <div class="col-12" id="tunnelsGrid" style="display: none;">
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                      <h5 class="card-title mb-0">
                        <i class="mdi mdi-pipe text-info mr-2"></i>
                        Active Tunnels
                      </h5>
                      <span class="badge badge-primary" id="tunnelCount">0 Tunnels</span>
                    </div>
                    <div class="table-responsive">
                      <table class="table table-hover">
                        <thead>
                          <tr>
                            <th>Tunnel</th>
                            <th>Status</th>
                            <th>ID</th>
                            <th>Created</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody id="tunnelsList">
                          <!-- Tunnel rows will be populated here -->
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Empty State -->
              <div class="col-12" id="emptyState" style="display: none;">
                <div class="card">
                  <div class="card-body text-center py-5">
                    <div class="preview-icon bg-light rounded-circle mx-auto mb-4" style="width: 80px; height: 80px; line-height: 80px;">
                      <i class="mdi mdi-pipe-disconnected text-muted" style="font-size: 32px;"></i>
                    </div>
                    <h4 class="text-muted mb-3">No Tunnels Found</h4>
                    <p class="text-muted mb-4">This account doesn't have any tunnels yet. Create your first tunnel to get started.</p>
                    <a href="/cloudflare/tunnels/create" class="btn btn-primary">
                      <i class="mdi mdi-plus mr-2"></i>Create Your First Tunnel
                    </a>
                  </div>
                </div>
              </div>

              <!-- No Account Selected State -->
              <div class="col-12" id="noAccountState">
                <div class="card">
                  <div class="card-body text-center py-5">
                    <div class="preview-icon bg-light rounded-circle mx-auto mb-4" style="width: 80px; height: 80px; line-height: 80px;">
                      <i class="mdi mdi-account-alert text-muted" style="font-size: 32px;"></i>
                    </div>
                    <h4 class="text-muted mb-3">No Account Selected</h4>
                    <p class="text-muted mb-4">Please select a Cloudflare account first to view and manage its tunnels.</p>
                    <a href="/cloudflare/accounts" class="btn btn-primary">
                      <i class="mdi mdi-account-multiple mr-2"></i>Select Account
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- content-wrapper ends -->
          <!-- partial:partials/_footer.html -->
          {{template "footer.html" .}}
          <!-- partial -->
        </div>
        <!-- main-panel ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>
    <!-- container-scroller -->

    <!-- Tunnel Details Modal -->
    <div class="modal fade" id="tunnelDetailsModal" tabindex="-1" role="dialog" aria-labelledby="tunnelDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="tunnelDetailsModalLabel">
              <i class="mdi mdi-information-outline mr-2"></i>Tunnel Details
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="tunnelDetailsContent">
            <!-- Tunnel details will be populated here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="getTunnelToken">
              <i class="mdi mdi-key mr-2"></i>Get Token
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteConfirmModalLabel">
              <i class="mdi mdi-alert-circle mr-2"></i>Confirm Deletion
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this tunnel? This action cannot be undone.</p>
            <div class="alert alert-warning">
              <i class="mdi mdi-alert-triangle mr-2"></i>
              <strong>Warning:</strong> Deleting this tunnel will disconnect all associated services.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteTunnel">
              <i class="mdi mdi-delete mr-2"></i>Delete Tunnel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Tunnel Name Modal -->
    <div class="modal fade" id="editTunnelNameModal" tabindex="-1" role="dialog" aria-labelledby="editTunnelNameModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editTunnelNameModalLabel">
              <i class="mdi mdi-pencil mr-2"></i>Edit Tunnel Name
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="editTunnelNameForm">
              <div class="form-group">
                <label for="editTunnelName">Tunnel Name</label>
                <input type="text" class="form-control" id="editTunnelName" placeholder="Enter tunnel name" required>
                <small class="form-text text-muted">The name must be unique within your account.</small>
              </div>
              <div class="form-group">
                <label>Current Name:</label>
                <span id="currentTunnelName" class="text-muted"></span>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmEditTunnelName">
              <i class="mdi mdi-check mr-2"></i>Update Name
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- plugins:js -->
    <script src="/assets/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- Plugin js for this page -->
    <!-- End plugin js for this page -->
    <!-- inject:js -->
    <script src="/assets/js/off-canvas.js"></script>
    <script src="/assets/js/hoverable-collapse.js"></script>
    <script src="/assets/js/misc.js"></script>
    <script src="/assets/js/settings.js"></script>
    <script src="/assets/js/todolist.js"></script>
    <!-- endinject -->
    <!-- Custom js for this page -->
    <script src="/assets/js/sidebar-account.js"></script>
    <script>
      $(document).ready(function() {
        let selectedAccountId = null;
        let selectedAccount = null;
        let currentTunnelId = null;
        
        // Load selected account from localStorage and initialize page
        initializePage();
        
        // Refresh tunnels
        $('#refreshTunnels').on('click', function() {
          console.log('Refresh button clicked');
          if ($(this).prop('disabled')) return; // Prevent multiple clicks
          
          // Get current account (with fallback to localStorage)
          const accountInfo = getCurrentAccount();
          
          if (accountInfo.id) {
            console.log('Account found, proceeding with refresh');
            const button = $(this);
            
            // Show loading state
            button.prop('disabled', true);
            const originalContent = button.html();
            button.html('<i class="mdi mdi-loading mdi-spin"></i> Refreshing...');
            
            // Update account display if it was loaded from localStorage
            if (accountInfo.account && !selectedAccount) {
              updateAccountDisplay();
            }
            
            loadTunnels(accountInfo.id).finally(() => {
              // Restore button state
              button.prop('disabled', false);
              button.html(originalContent);
            });
          } else {
            console.log('No account found, showing warning');
            showNotification('warning', 'Please select an account from the Accounts page first');
          }
        });
        
        // View tunnel details
        $(document).on('click', '.view-tunnel-btn', function() {
          if ($(this).prop('disabled')) return; // Prevent multiple clicks
          
          const tunnelId = $(this).data('tunnel-id');
          const button = $(this);
          
          // Show loading state
          button.prop('disabled', true);
          const originalContent = button.html();
          button.html('<i class="mdi mdi-loading mdi-spin"></i>');
          
          viewTunnelDetails(tunnelId).finally(() => {
            // Restore button state
            button.prop('disabled', false);
            button.html(originalContent);
          });
        });
        
        // Edit tunnel name
        $(document).on('click', '.edit-tunnel-btn', function() {
          const tunnelId = $(this).data('tunnel-id');
          const tunnelName = $(this).data('tunnel-name');
          currentTunnelId = tunnelId;
          
          // Set current name in modal
          $('#currentTunnelName').text(tunnelName);
          $('#editTunnelName').val(tunnelName);
          
          // Show modal
          $('#editTunnelNameModal').modal('show');
        });
        
        // Delete tunnel
        $(document).on('click', '.delete-tunnel-btn', function() {
          currentTunnelId = $(this).data('tunnel-id');
          const tunnelName = $(this).data('tunnel-name');
          $('#deleteConfirmModal').modal('show');
        });
        
        // Manage public hostnames
        $(document).on('click', '.manage-hostnames-btn', function(e) {
          e.stopPropagation(); // Prevent row click
          const tunnelId = $(this).data('tunnel-id');
          const tunnelName = $(this).data('tunnel-name');
          redirectToPublicHostnames(tunnelId, tunnelName);
        });
        
        // Tunnel row click - redirect to public hostnames page
        $(document).on('click', '.tunnel-row', function() {
          const tunnelId = $(this).data('tunnel-id');
          const tunnelName = $(this).data('tunnel-name');
          redirectToPublicHostnames(tunnelId, tunnelName);
        });
        
        // Prevent row click when clicking on action buttons
        $(document).on('click', '.tunnel-row .btn', function(e) {
          e.stopPropagation();
        });
        
        // Confirm edit tunnel name
        $('#confirmEditTunnelName').on('click', function() {
          if ($(this).prop('disabled')) return; // Prevent multiple clicks
          
          const newName = $('#editTunnelName').val().trim();
          if (!newName) {
            showNotification('warning', 'Please enter a valid tunnel name');
            return;
          }
          
          updateTunnelName(currentTunnelId, newName);
        });
        
        // Confirm delete tunnel
        $('#confirmDeleteTunnel').on('click', function() {
          if ($(this).prop('disabled')) return; // Prevent multiple clicks
          deleteTunnel(currentTunnelId);
        });
        
        // Get tunnel token
        $('#getTunnelToken').on('click', function() {
          if ($(this).prop('disabled')) return; // Prevent multiple clicks
          
          if (currentTunnelId) {
            const button = $(this);
            
            // Show loading state
            button.prop('disabled', true);
            const originalContent = button.html();
            button.html('<i class="mdi mdi-loading mdi-spin mr-2"></i>Getting Token...');
            
            getTunnelToken(currentTunnelId).finally(() => {
              // Restore button state
              button.prop('disabled', false);
              button.html(originalContent);
            });
          }
        });
        
        // Handle Enter key in edit tunnel name input
        $('#editTunnelName').on('keypress', function(e) {
          if (e.which === 13) { // Enter key
            e.preventDefault();
            $('#confirmEditTunnelName').click();
          }
        });
        
        // Validate tunnel name input
        $('#editTunnelName').on('input', function() {
          const name = $(this).val().trim();
          const button = $('#confirmEditTunnelName');
          
          if (name.length === 0) {
            button.prop('disabled', true);
            $(this).removeClass('is-valid').addClass('is-invalid');
          } else if (name.length > 63) {
            button.prop('disabled', true);
            $(this).removeClass('is-valid').addClass('is-invalid');
          } else {
            button.prop('disabled', false);
            $(this).removeClass('is-invalid').addClass('is-valid');
          }
        });
        
        // Reset edit modal when closed
        $('#editTunnelNameModal').on('hidden.bs.modal', function() {
          $('#editTunnelName').val('').removeClass('is-valid is-invalid');
          $('#confirmEditTunnelName').prop('disabled', false);
          currentTunnelId = null;
        });
        
        // Listen for account selection changes from other pages
        window.addEventListener('accountSelected', function(event) {
          selectedAccount = event.detail;
          selectedAccountId = selectedAccount.id;
          updateAccountDisplay();
          loadTunnels(selectedAccountId);
        });
        
        // Listen for storage changes (when account is selected in another tab)
        window.addEventListener('storage', function(event) {
          if (event.key === 'selectedAccount') {
            initializePage();
          }
        });
      });
      
      // Initialize page with stored account
      function initializePage() {
        const savedAccount = localStorage.getItem('selectedAccount');
        if (savedAccount) {
          try {
            selectedAccount = JSON.parse(savedAccount);
            selectedAccountId = selectedAccount.id;
            console.log('Account loaded:', selectedAccount.name, selectedAccountId);
            updateAccountDisplay();
            loadTunnels(selectedAccountId);
          } catch (error) {
            console.error('Error parsing selected account:', error);
            selectedAccount = null;
            selectedAccountId = null;
            showNoAccountState();
          }
        } else {
          console.log('No saved account found');
          selectedAccount = null;
          selectedAccountId = null;
          showNoAccountState();
        }
      }
      
      // Update account display
      function updateAccountDisplay() {
        console.log('Updating account display. selectedAccount:', selectedAccount, 'selectedAccountId:', selectedAccountId);
        if (selectedAccount) {
          $('#currentAccountName').text(selectedAccount.name);
          $('#currentAccountId').text(`ID: ${selectedAccount.id.substring(0, 8)}...`);
          $('#currentAccountBadge').text(selectedAccount.name).removeClass('badge-info').addClass('badge-success');
          $('#noAccountWarning').hide();
          $('#currentAccountInfo').show();
        } else {
          $('#currentAccountName').text('No Account Selected');
          $('#currentAccountId').text('Please select an account from the Accounts page');
          $('#currentAccountBadge').text('No Account Selected').removeClass('badge-success').addClass('badge-info');
          $('#noAccountWarning').show();
          $('#currentAccountInfo').hide();
        }
      }
      
      
      // Load tunnels for selected account
      function loadTunnels(accountId) {
        showLoadingState();
        
        return fetch(`/api/cloudflare/accounts/${accountId}/tunnels`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
          hideLoadingState();
          
          if (data.status === 'success' && data.data && data.data.tunnels) {
            if (data.data.tunnels.length > 0) {
              renderTunnels(data.data.tunnels);
              showTunnelsGrid();
              showNotification('success', `Loaded ${data.data.tunnels.length} tunnels`);
            } else {
              showEmptyState();
            }
          } else {
            showEmptyState();
            showNotification('info', 'No tunnels found for this account');
          }
        })
        .catch(error => {
          hideLoadingState();
          console.error('Error loading tunnels:', error);
          showEmptyState();
          showNotification('error', 'Failed to load tunnels');
        });
      }
      
      // Render tunnels in table
      function renderTunnels(tunnels) {
        const tbody = $('#tunnelsList');
        tbody.empty();
        
        tunnels.forEach(tunnel => {
          const createdDate = tunnel.created_at ? new Date(tunnel.created_at).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
          }) : 'N/A';
          
          const status = tunnel.status || 'inactive';
          const statusBadge = getStatusBadge(status);
          
          const row = `
            <tr class="tunnel-row" data-tunnel-id="${tunnel.id}" data-tunnel-name="${tunnel.name}">
              <td>
                <div class="d-flex align-items-center">
                  <div class="preview-icon bg-gradient-primary rounded-circle mr-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                    <i class="mdi mdi-pipe text-white"></i>
                  </div>
                  <div>
                    <h6 class="mb-1 font-weight-medium">${tunnel.name}</h6>
                    <p class="text-muted small mb-0">${tunnel.id.substring(0, 8)}...</p>
                  </div>
                </div>
              </td>
              <td>${statusBadge}</td>
              <td>
                <code class="small bg-light text-dark px-2 py-1 rounded">${tunnel.id}</code>
              </td>
              <td class="text-muted">${createdDate}</td>
              <td>
                <div class="btn-group" role="group">
                  <button class="btn btn-outline-success btn-sm manage-hostnames-btn" 
                          data-tunnel-id="${tunnel.id}" 
                          data-tunnel-name="${tunnel.name}"
                          title="Manage public hostnames">
                    <i class="mdi mdi-earth"></i>
                  </button>
                  <button class="btn btn-outline-info btn-sm view-tunnel-btn" 
                          data-tunnel-id="${tunnel.id}" 
                          data-tunnel-name="${tunnel.name}"
                          title="View tunnel details">
                    <i class="mdi mdi-eye"></i>
                  </button>
                  <button class="btn btn-outline-warning btn-sm edit-tunnel-btn" 
                          data-tunnel-id="${tunnel.id}" 
                          data-tunnel-name="${tunnel.name}"
                          title="Edit tunnel name">
                    <i class="mdi mdi-pencil"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm delete-tunnel-btn" 
                          data-tunnel-id="${tunnel.id}" 
                          data-tunnel-name="${tunnel.name}"
                          title="Delete tunnel">
                    <i class="mdi mdi-delete"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
          
          tbody.append(row);
        });
        
        $('#tunnelCount').text(`${tunnels.length} Tunnel${tunnels.length !== 1 ? 's' : ''}`);
      }
      
      // Get status badge HTML
      function getStatusBadge(status) {
        const statusClasses = {
          'active': 'badge-success',
          'inactive': 'badge-warning',
          'degraded': 'badge-danger',
          'healthy': 'badge-success'
        };
        
        const badgeClass = statusClasses[status] || 'badge-secondary';
        return `<span class="badge ${badgeClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>`;
      }
      
      // View tunnel details
      function viewTunnelDetails(tunnelId) {
        currentTunnelId = tunnelId;
        
        return fetch(`/api/cloudflare/accounts/${selectedAccountId}/tunnels/${tunnelId}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && data.data.tunnel) {
            displayTunnelDetails(data.data.tunnel);
            $('#tunnelDetailsModal').modal('show');
          } else {
            showNotification('error', 'Failed to load tunnel details');
          }
        })
        .catch(error => {
          console.error('Error loading tunnel details:', error);
          showNotification('error', 'Failed to load tunnel details');
        });
      }
      
      // Display tunnel details in modal
      function displayTunnelDetails(tunnel) {
        const detailsHtml = `
          <div class="row">
            <div class="col-md-6">
              <h6>Basic Information</h6>
              <table class="table table-borderless table-sm">
                <tr>
                  <td><strong>Name:</strong></td>
                  <td>${tunnel.name}</td>
                </tr>
                <tr>
                  <td><strong>ID:</strong></td>
                  <td><code>${tunnel.id}</code></td>
                </tr>
                <tr>
                  <td><strong>Status:</strong></td>
                  <td>${getStatusBadge(tunnel.status || 'inactive')}</td>
                </tr>
                <tr>
                  <td><strong>Created:</strong></td>
                  <td>${tunnel.created_at ? new Date(tunnel.created_at).toLocaleString() : 'N/A'}</td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <h6>Configuration</h6>
              <table class="table table-borderless table-sm">
                <tr>
                  <td><strong>Remote Config:</strong></td>
                  <td>${tunnel.remote_config ? 'Yes' : 'No'}</td>
                </tr>
                <tr>
                  <td><strong>Tunnel Type:</strong></td>
                  <td>${tunnel.tunnel_type || 'cfd_tunnel'}</td>
                </tr>
              </table>
            </div>
          </div>
        `;
        
        $('#tunnelDetailsContent').html(detailsHtml);
      }
      
      // Delete tunnel function
      function deleteTunnel(tunnelId) {
        // Show loading state
        const button = $('#confirmDeleteTunnel');
        button.prop('disabled', true);
        const originalContent = button.html();
        button.html('<i class="mdi mdi-loading mdi-spin mr-2"></i>Deleting...');
        
        // Disable modal close buttons during operation
        $('#deleteConfirmModal .close, #deleteConfirmModal [data-dismiss="modal"]').prop('disabled', true);
        
        fetch(`/api/cloudflare/accounts/${selectedAccountId}/tunnels/${tunnelId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
          $('#deleteConfirmModal').modal('hide');
          
          if (data.status === 'success') {
            showNotification('success', 'Tunnel deleted successfully');
            loadTunnels(selectedAccountId);
          } else {
            showNotification('error', data.message || 'Failed to delete tunnel');
          }
        })
        .catch(error => {
          $('#deleteConfirmModal').modal('hide');
          console.error('Error deleting tunnel:', error);
          showNotification('error', 'Failed to delete tunnel');
        })
        .finally(() => {
          // Restore button state
          button.prop('disabled', false);
          button.html(originalContent);
          
          // Re-enable modal close buttons
          $('#deleteConfirmModal .close, #deleteConfirmModal [data-dismiss="modal"]').prop('disabled', false);
        });
      }
      
      // Get tunnel token
      function getTunnelToken(tunnelId) {
        return fetch(`/api/cloudflare/accounts/${selectedAccountId}/tunnels/${tunnelId}/token`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && data.data.token) {
            copyToClipboard(data.data.token);
            showNotification('success', 'Token copied to clipboard');
          } else {
            showNotification('error', 'Failed to get tunnel token');
          }
        })
        .catch(error => {
          console.error('Error getting tunnel token:', error);
          showNotification('error', 'Failed to get tunnel token');
        });
      }
      
      // Update tunnel name
      function updateTunnelName(tunnelId, newName) {
        // Show loading state
        const button = $('#confirmEditTunnelName');
        button.prop('disabled', true);
        const originalContent = button.html();
        button.html('<i class="mdi mdi-loading mdi-spin mr-2"></i>Updating...');
        
        // Disable modal close buttons during operation
        $('#editTunnelNameModal .close, #editTunnelNameModal [data-dismiss="modal"]').prop('disabled', true);
        
        fetch(`/api/cloudflare/accounts/${selectedAccountId}/tunnels/${tunnelId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin',
          body: JSON.stringify({ name: newName })
        })
        .then(response => {
          // Check if response is ok
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          // Check if response is JSON
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Response is not JSON');
          }
          
          return response.json();
        })
        .then(data => {
          $('#editTunnelNameModal').modal('hide');
          
          if (data.status === 'success') {
            showNotification('success', 'Tunnel name updated successfully');
            loadTunnels(selectedAccountId);
          } else {
            showNotification('error', data.message || 'Failed to update tunnel name');
          }
        })
        .catch(error => {
          $('#editTunnelNameModal').modal('hide');
          console.error('Error updating tunnel name:', error);
          
          // More specific error messages
          if (error.message.includes('HTTP error! status: 404')) {
            showNotification('error', 'API endpoint not found. Please check if the server supports tunnel name updates.');
          } else if (error.message.includes('HTTP error! status: 500')) {
            showNotification('error', 'Server error occurred while updating tunnel name.');
          } else if (error.message.includes('Response is not JSON')) {
            showNotification('error', 'Server returned an invalid response. Please try again.');
          } else {
            showNotification('error', 'Failed to update tunnel name. Please try again.');
          }
        })
        .finally(() => {
          // Restore button state
          button.prop('disabled', false);
          button.html(originalContent);
          
          // Re-enable modal close buttons
          $('#editTunnelNameModal .close, #editTunnelNameModal [data-dismiss="modal"]').prop('disabled', false);
        });
      }
      
      // Copy to clipboard function
      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
          console.log('Text copied to clipboard');
        }).catch(err => {
          console.error('Could not copy text: ', err);
        });
      }
      
      // Redirect to public hostnames page
      function redirectToPublicHostnames(tunnelId, tunnelName) {
        // Store tunnel info in localStorage for the public hostnames page
        const tunnelInfo = {
          id: tunnelId,
          name: tunnelName,
          accountId: selectedAccountId
        };
        
        localStorage.setItem('selectedTunnel', JSON.stringify(tunnelInfo));
        
        // Redirect to public hostnames page
        window.location.href = `/Cloudflare_TunnelPublicHostname?tunnelId=${tunnelId}&accountId=${selectedAccountId}`;
      }
      
      // Helper function to get current account (with fallback to localStorage)
      function getCurrentAccount() {
        console.log('getCurrentAccount called. selectedAccount:', selectedAccount, 'selectedAccountId:', selectedAccountId);
        
        if (selectedAccount && selectedAccountId) {
          console.log('Using cached account:', selectedAccount.name);
          return { account: selectedAccount, id: selectedAccountId };
        }
        
        const savedAccount = localStorage.getItem('selectedAccount');
        console.log('Checking localStorage for account:', savedAccount);
        
        if (savedAccount) {
          try {
            const account = JSON.parse(savedAccount);
            selectedAccount = account;
            selectedAccountId = account.id;
            console.log('Loaded account from localStorage:', account.name, account.id);
            return { account: account, id: account.id };
          } catch (error) {
            console.error('Error parsing selected account:', error);
            return { account: null, id: null };
          }
        }
        
        console.log('No account found');
        return { account: null, id: null };
      }
      
      // State management functions
      function showLoadingState() {
        $('#loadingState').show();
        $('#tunnelsGrid').hide();
        $('#emptyState').hide();
        $('#noAccountState').hide();
      }
      
      function hideLoadingState() {
        $('#loadingState').hide();
      }
      
      function showTunnelsGrid() {
        $('#tunnelsGrid').show();
        $('#emptyState').hide();
        $('#noAccountState').hide();
      }
      
      function showEmptyState() {
        $('#emptyState').show();
        $('#tunnelsGrid').hide();
        $('#noAccountState').hide();
      }
      
      function showNoAccountState() {
        $('#noAccountState').show();
        $('#tunnelsGrid').hide();
        $('#emptyState').hide();
      }
      
      // Notification function
      function showNotification(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-danger' : 
                          type === 'warning' ? 'alert-warning' : 'alert-info';
        
        const notification = $(`
          <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
               style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            <strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        `);
        
        $('body').append(notification);
        
        setTimeout(() => {
          notification.alert('close');
        }, 5000);
      }
    </script>
    
    <style>
      /* Tunnel row styling */
      .tunnel-row {
        transition: all 0.3s ease;
        cursor: pointer;
        animation: fadeInUp 0.3s ease-out;
      }
      
      .tunnel-row:hover {
        background-color: #f8f9fa !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      
      .tunnel-row:hover td {
        color: #343a40 !important;
        background-color: transparent !important;
      }
      
      /* Table styling */
      .table th {
        border-top: none;
        font-weight: 600;
        color: #ffffff;
        background-color: #000000;
        padding: 1rem 0.75rem;
      }
      
      /* Tunnel name styling */
      .tunnel-row h6 {
        color: white !important;
      }
      
      .table td {
        vertical-align: middle;
        padding: 1rem 0.75rem;
        border-color: #e9ecef;
      }
      
      .table-responsive {
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #e9ecef;
      }
      
      .table {
        margin-bottom: 0;
      }
      
      /* Button styling */
      .btn-group .btn {
        margin-right: 0.25rem;
      }
      
      .btn-group .btn:last-child {
        margin-right: 0;
      }
      
      /* Modal styling */
      .modal-content {
        border-radius: 8px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      }
      
      .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px 8px 0 0;
      }
      
      .modal-header .close {
        color: white;
        opacity: 0.8;
      }
      
      .modal-header .close:hover {
        opacity: 1;
      }
      
      /* Badge styling */
      .badge {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
      }
      
      .badge-success {
        background-color: #28a745;
        color: white;
      }
      
      .badge-warning {
        background-color: #ffc107;
        color: #212529;
      }
      
      .badge-danger {
        background-color: #dc3545;
        color: white;
      }
      
      .badge-info {
        background-color: #17a2b8;
        color: white;
      }
      
      .badge-primary {
        background-color: #007bff;
        color: white;
      }
      
      /* Row animations */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translate3d(0, 20px, 0);
        }
        to {
          opacity: 1;
          transform: translate3d(0, 0, 0);
        }
      }
      
      .tunnel-row:nth-child(1) { animation-delay: 0.1s; }
      .tunnel-row:nth-child(2) { animation-delay: 0.2s; }
      .tunnel-row:nth-child(3) { animation-delay: 0.3s; }
      .tunnel-row:nth-child(4) { animation-delay: 0.4s; }
      .tunnel-row:nth-child(5) { animation-delay: 0.5s; }
      
      /* Account select styling */
      .form-control {
        border-radius: 6px;
      }
      
      .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }
      
      /* Loading animation */
      .mdi-spin {
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Disabled button styling */
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      
      /* Form validation styling */
      .form-control.is-valid {
        border-color: #28a745;
      }
      
      .form-control.is-invalid {
        border-color: #dc3545;
      }
      
      .form-control.is-valid:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
      }
      
      .form-control.is-invalid:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
      }
      
      /* Edit button styling */
      .btn-outline-warning {
        color: #ffc107;
        border-color: #ffc107;
      }
      
      .btn-outline-warning:hover {
        color: #212529;
        background-color: #ffc107;
        border-color: #ffc107;
      }
      
      .btn-outline-warning:not(:disabled):not(.disabled):active {
        color: #212529;
        background-color: #ffc107;
        border-color: #ffc107;
      }
      
      /* Success button styling for hostnames */
      .btn-outline-success {
        color: #28a745;
        border-color: #28a745;
      }
      
      .btn-outline-success:hover {
        color: #fff;
        background-color: #28a745;
        border-color: #28a745;
      }
      
      .btn-outline-success:not(:disabled):not(.disabled):active {
        color: #fff;
        background-color: #28a745;
        border-color: #28a745;
      }
    </style>
    <!-- End custom js for this page -->
  </body>
</html>
